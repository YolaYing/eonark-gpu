# before driver update
# ICICLE
export ICICLE_LIB="$HOME/.local/icicle/lib"
export LD_LIBRARY_PATH="$ICICLE_LIB${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
export CGO_LDFLAGS="-L$ICICLE_LIB -Wl,-rpath,$ICICLE_LIB ${CGO_LDFLAGS}"
export LIBRARY_PATH="$ICICLE_LIB${LIBRARY_PATH:+:$LIBRARY_PATH}"
export ICICLE_BACKEND_INSTALL_DIR="$HOME/.local/icicle/lib/backend"
export ICICLE_BACKEND=cuda

# CUDA 12.8
export CUDA_HOME="/usr/local/cuda-12.8"
export PATH="$CUDA_HOME/bin:$PATH"
export LD_LIBRARY_PATH="$CUDA_HOME/lib64:$CUDA_HOME/extras/CUPTI/lib64:$LD_LIBRARY_PATH"

# Nsight Systems
export NSYS_HOME="$HOME/.local/opt/nsight-systems"
export NSYS_ROOT="$NSYS_HOME/opt/nvidia/nsight-systems"
if verdir="$(ls -d "$NSYS_ROOT"/* 2>/dev/null | head -n1)"; then
  export PATH="$verdir/bin:$verdir/target-linux-x64:$verdir/host-linux-x64:$PATH"
  export LD_LIBRARY_PATH="$verdir/host-linux-x64:$LD_LIBRARY_PATH"
fi

# ===== 临时修复区（管理员重启完成后删除/注释）=====
# 若你在本地装了 CUDA 13.0.0，就优先用它；否则继续用系统 CUDA
if [ -x "$HOME/cuda-13.0.0/bin/nvcc" ]; then
  export CUDA_HOME="$HOME/cuda-13.0.0"
  export PATH="$CUDA_HOME/bin:$PATH"
fi

# 运行期 LD_LIBRARY_PATH 顺序非常关键：
# ① 你的私有 NV 驱动用户态库（含 libnvidia-ml.so.1 & libcuda.so.1 的 580.65.06 版本）
# ② ICICLE 自己的 .so（让运行期能找到 libicicle_*.so）
# ③ 系统驱动目录（/usr/lib/x86_64-linux-gnu，补齐依赖）
# ④ CUDA Toolkit（$CUDA_HOME/lib64 & CUPTI）
# ⑤ 其他继承
export LD_LIBRARY_PATH="$HOME/nvdrivers/580.65.06/lib:$ICICLE_LIB:/usr/lib/x86_64-linux-gnu:${CUDA_HOME}/lib64:${CUDA_HOME}/extras/CUPTI/lib64:${LD_LIBRARY_PATH}"
